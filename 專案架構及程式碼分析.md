# 專案架構及程式碼分析

## 1. 專案概述 (Project Overview)
本專案為一個現代化的 **倉庫出入料管理系統 (WMS)**，旨在提供直觀的庫存管理、即時的平面圖視覺化監控，以及高效的出入庫作業流程。

### 技術棧 (Tech Stack)
- **Frontend**: React 18, Vite, Tailwind CSS, Framer Motion (動畫), Lucide React (圖標)
- **Backend**: Node.js, Express.js
- **Database**: SQLite (透過 `better-sqlite3` 驅動)
- **Infrastructure**: Docker, Docker Compose
- **Tools**: Excel (xlsx) 資料匯入

---

## 2. 專案目錄結構 (Directory Structure)

```text
倉庫出入料系統/
├── client/                 # 前端應用程式 (React + Vite)
│   ├── src/
│   │   ├── components/     # 共用元件 (MapGrid, Layout)
│   │   ├── pages/          # 頁面元件 (Dashboard, Inventory, Operations)
│   │   ├── api.js          # API 請求封裝 (Axios)
│   │   └── ...
│   ├── index.html
│   ├── tailwind.config.js  # 樣式配置
│   └── vite.config.js      # 建置配置
├── server/                 # 後端應用程式 (Node.js + Express)
│   ├── server.js           # 核心伺服器邏輯 & API路由
│   ├── warehouse.db        # SQLite 資料庫文件
│   └── inspect_excel.js    # Excel 數據檢測工具
├── Dockerfile              # 容器化定義
├── docker-compose.yml      # 服務編排
├── run_locally.bat         # 本地快速啟動腳本
├── 20260210 料架QRcode.xlsx # 原始儲位資料來源
└── Debug流程_1150212.md     # 開發調試紀錄
```

---

## 3. 核心模組與程式碼分析

### 3.1 後端伺服器 (`server/server.js`)
後端採用單一文件結構，整合了伺服器啟動、資料庫初始化與 API 路由，適合輕量級應用。

#### **關鍵功能：**
1.  **資料庫初始化 (`initDb`)**:
    - 啟動時自動檢查並建立 `locations`, `items`, `inventory`, `transactions` 四張資料表。
    - **Excel 自動匯入 (`seedLocations`)**: 若偵測到資料庫無儲位資料，會自動讀取 `20260210 料架QRcode.xlsx`，解析儲位代碼 (如 `4-A-1-1`) 並寫入資料庫。
2.  **API 介面**:
    - `GET /api/locations`: 獲取所有儲位資訊及當前庫存量 (用於平面圖)。
    - `GET /api/items`: 搜尋料件 (支援 Keyword/Barcode)。
    - `POST /api/transaction`: 處理出入庫交易，支援事務 (Transaction) 原子性操作，確保庫存數據一致。

### 3.2 資料庫設計 (Schema)
| 資料表 | 用途 | 關鍵欄位 |
| :--- | :--- | :--- |
| **locations** | 儲位主檔 | `id`, `code` (代碼), `x`, `y` (座標), `type` |
| **items** | 料件主檔 | `id`, `barcode`, `name`, `description` |
| **inventory** | 即時庫存 | `item_id`, `location_id`, `quantity` |
| **transactions** | 交易紀錄 | `type` (IN/OUT), `quantity`, `timestamp`, `ref_order` |

### 3.3 前端視覺化 (`client/src/components/MapGrid.jsx`)
這是本系統最核心的視覺化元件，負責渲染倉庫平面圖。

#### **渲染邏輯：**
1.  **動態網格計算**:
    - 根據 API 回傳的 location 數據，自動計算最大 X 與 Y 軸，動態生成 Grid Layout。
2.  **標題與座標 (`Header` & `Row Label`)**:
    - **Top Header**: 解析該行第一列的儲位代碼 (去除 `-`，如 `4A11`) 顯示於上方。
    - **Left Label**: 自動生成 1~12 的列編號顯示於左側。
3.  **儲位單元 (Cell)**:
    - 根據 `total_quantity` 判斷是否顯示庫存。
    - **互動**: 滑鼠懸停 (Hover) 時顯示詳細資訊 Tooltip。
    - **動畫**: 使用 `framer-motion` 實現載入時的縮放與淡入效果，以及庫存變動時的 Ping 動畫。

### 3.4 頁面功能
- **Dashboard (`pages/Dashboard.jsx`)**:
    - 整合 `MapGrid`，並顯示關鍵指標 (KPI) 卡片：庫存總數、佔用儲位、低庫存警示。
    - 採用每 5 秒輪詢 (Polling) 機制確保數據即時性。
- **Inventory (`pages/Inventory.jsx`)**:
    - 提供列表式查詢，支援模糊搜尋。
- **Operations (`pages/Operations.jsx`)**:
    - 執行入庫/出庫作業。
    - 實作「雙重掃描驗證」：需先掃描料件，再掃描儲位卡，最後輸入數量，確保作業正確。

---

## 4. 基礎設施 (Infrastructure)

### Docker 配置
- **Dockerfile**:
    - 使用 Multi-stage build 減小映像檔體積。
    - 針對 `better-sqlite3` 進行了 Native Module 的編譯處理 (使用 `python3`, `make`, `g++`) 以適應 Alpine Linux 環境。
- **Docker Compose**:
    - 定義了 `wms-app` 服務，映射 Port `3000` (Backend) 與 `5173` (Frontend)。
    - 設定 Volume 掛載，確保資料庫與 Excel 檔案持久化且與宿主機同步。

---

## 5. 總結
本系統採用了前後端分離的現代化架構，具有以下優勢：
1.  **部署彈性**: 可透過 Docker 一鍵部署，亦可本地直接執行。
2.  **視覺化管理**: 將傳統的列表式管理轉化為直觀的平面圖，大幅降低人員找貨時間。
3.  **擴充性**: 資料庫設計正規化，API 結構清晰，未來易於串接 ERP 或其他系統。
