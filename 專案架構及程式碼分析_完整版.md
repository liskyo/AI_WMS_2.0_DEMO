# 倉庫出入料管理系統 (WMS) - 專案架構及程式碼分析 (完整版)

## 1. 專案概述 (Project Overview)
本專案為一個現代化的 **倉庫出入料管理系統 (WMS)**，旨在提供直觀的庫存管理、即時的平面圖視覺化監控，以及高效的出入庫作業流程。
本文件包含了截至 **2026/02/12** 的最新功能分析，包括交易作廢 (Soft Delete)、權限控管、報表優化與時區修正等。

### 技術棧 (Tech Stack)
- **Frontend**: React 18, Vite, Tailwind CSS, Framer Motion (動畫), Lucide React (圖標), Axois
- **Backend**: Node.js, Express.js (REST API)
- **Database**: SQLite (透過 `better-sqlite3` 高效驅動)
- **Infrastructure**: Docker, Docker Compose (支援跨平台部署)
- **Tools**: XLSX (Excel 匯入/匯出)

---

## 2. 專案目錄結構 (Directory Structure)

```text
倉庫出入料系統/
├── client/                 # 前端應用程式 (React + Vite)
│   ├── src/
│   │   ├── components/     # 共用元件
│   │   │   ├── MapGrid.jsx # 核心平面圖元件 (視覺化庫存)
│   │   │   └── Layout.jsx  # 全局版面配置 (Sidebar, Auth Check)
│   │   ├── pages/          # 頁面元件
│   │   │   ├── Dashboard.jsx          # 總覽看板 (KPIs + Map)
│   │   │   ├── Operations.jsx         # 出入庫作業 (掃描驗證)
│   │   │   ├── TransactionHistory.jsx # 出入庫紀錄 (作廢功能)
│   │   │   ├── Reports.jsx            # 庫存報表 (多維度統計)
│   │   │   ├── UserManagement.jsx     # 人員管理 (權限設定)
│   │   │   └── ...
│   │   ├── api.js          # API 請求封裝 (Axios Instance)
│   │   └── context/        # React Context (AuthContext)
├── server/                 # 後端應用程式
│   ├── server.js           # 核心伺服器邏輯, API 路由, 資料庫初始化
│   ├── warehouse.db        # SQLite 資料庫文件
│   └── ...
├── Dockerfile              # Container 定義 (Multi-stage build)
├── docker-compose.yml      # 服務編排 (App + Volume Binding)
└── ...
```

---

## 3. 核心模組與資料庫設計

### 3.1 資料庫 Schema (SQLite)

| 資料表 | 用途 | 關鍵欄位 | 備註 |
| :--- | :--- | :--- | :--- |
| **locations** | 儲位主檔 | `id`, `code` (代碼), `x`, `y` (座標) | 支援平面圖座標映射 |
| **items** | 料件主檔 | `id`, `barcode`, `name`, `category` | 唯一條碼識別 |
| **inventory** | 即時庫存 | `item_id`, `location_id`, `quantity` | 複合唯一鍵 (Item + Location), 數量 > 0 |
| **users** | 使用者 | `id`, `employee_id`, `password`, `permissions` | 權限包含 JSON 格式 (e.g. `['ALL']`) |
| **transactions** | 交易紀錄 | `type`, `quantity`, `timestamp`, `is_deleted`, `deleted_by` | **支援交易作廢 (Soft Delete)** |

### 3.2 後端伺服器功能 (`server/server.js`)

#### **關鍵機制：**
1.  **資料庫遷移 (Migration)**: 啟動時自動檢查 Schema，若欄位缺失 (如 `deleted_by`) 會自動執行 `ALTER TABLE` 補丁。
2.  **交易原子性 (Atomic Transaction)**:
    - 所有的出入庫操作皆包裝在 `db.transaction()` 中。
    - **庫存作廢邏輯**: 管理員執行作廢時，系統會：
        1. 標記 `is_deleted = 1`。
        2. 記錄 `deleted_by` (刪除者工號)。
        3. **反向沖銷庫存**: 若原為入庫則扣除庫存，若原為出庫則加回庫存。
3.  **快取控制**: 針對 `/api/transactions` 等頻繁變動的 API，設定 `Cache-Control: no-store` 以防止瀏覽器讀取過期數據。

#### **主要 API 列表：**
- `POST /api/transaction`: 執行出/入庫。
- `POST /api/admin/transactions/:id/void`: **(新功能)** 作廢交易，需管理員權限 + 密碼驗證。
- `GET /api/reports/inventory`: 獲取完整庫存報表，自動過濾數量為 0 的無效庫存。
- `GET /api/items`: 搜尋料件 (支援中英文、條碼)。

---

## 4. 前端頁面與功能分析

### 4.1 總覽看板 (`Dashboard.jsx`)
- **KPI 卡片**: 顯示「庫存總數」、「佔用儲位」、「低庫存警示」。
- **快速導航**: 點擊 KPI 卡片可直接跳轉至對應的報表分頁 (`/reports?tab=item` 或 `location`)。
- **即時平面圖**: 整合 `<MapGrid />`，透過顏色深淺或動態標記顯示庫存分佈。
    - **詳細 Tooltip**: 游標懸停時，顯示儲位代碼及內部所有料件的詳細清單 (條碼/品名/數量)，支援多料件同時顯示。

### 4.2 出入庫紀錄 (`TransactionHistory.jsx`)
- **時區修正**: 針對後端 UTC 時間，前端強制轉換為 **Asia/Taipei** (UTC+8)，解決顯示慢 8 小時的問題。
- **作廢功能**:
    - 僅「管理者」可見刪除按鈕 (Trash Icon)。
    - 支援搜尋過濾：可同時搜尋「建立者」與「刪除者」。
    - 視覺化區隔：已作廢的交易會顯示半透明並標註「已刪除」。

### 4.3 庫存報表 (`Reports.jsx`)
- **雙維度檢視**:
    - **料件總表 (Item Tab)**: 依料件聚合，顯示該料件分佈在哪些儲位。
    - **儲位總表 (Location Tab)**: 依儲位聚合，顯示該儲位內有哪些料件。
- **排序優化**: 儲位列表依自然排序法 (Natural Sort) 排列 (例如 `4-A-1-2` 會排在 `4-A-1-10` 之前)。
- **匯出功能**: 支援一鍵匯出 Excel，包含詳細庫存快照。

### 4.4 出入庫作業 (`Operations.jsx`)
- **防呆機制 (Poka-yoke)**: 強制流程：`掃描料件` -> `掃描儲位` -> `輸入數量` -> `確認`，防止誤操作。

---

## 5. 系統部署 (Infrastructure)

### Docker 容器化
專案已完全容器化，可透過 `run_locally.bat` 或 `docker-compose up -d` 啟動。
- **Backend Port**: 3000
- **Frontend Port**: 5173 (開發模式) 或 Nginx 伺服 (生產模式)
- **Data Persistence**: `warehouse.db` 與 `uploads/` 目錄皆掛載至 Host，確保數據不因容器重啟而丟失。

---

## 6. 近期更新日誌 (2026/02/12)

1.  **交易作廢機制 (Void Transaction)**: 實現 Soft Delete，支援庫存回滾與刪除者稽核 (Audit Trail)。
2.  **報表顯示優化**: 修復數量為 0 的庫存仍顯示的問題。
3.  **UI/UX 改進**:
    - 修正時間顯示 (UTC -> Taipei)。
    - 增加看板至報表的快速連結。
    - 改善報表排序邏輯。
4.  **權限架構**: 初步導入 Role-Based Access Control (RBAC)，區分 Admin 與一般 User 操作權限。
5.  **平面圖資訊增強**: 實作詳細庫存 Tooltip。
    - **架構決策**: 為避免 SQLite `GROUP_CONCAT` 在複雜查詢下的穩定性問題，改採用 **Application-Level Join** 策略。後端分別撈取 Locations 與 Inventory Data，再於 JavaScript 層進行合併，大幅提升系統穩定度與資料正確性。
