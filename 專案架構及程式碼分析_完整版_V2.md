# 倉庫出入料系統 (WMS) - 專案架構及程式碼分析 V2

本文件提供「倉庫出入料系統」的完整專案架構與核心程式碼深度分析，反映了最新的系統功能狀態（包含改善後的動態儲位圖、真正的覆蓋式 Excel 匯入、以及 BOM 表出庫等機制）。

---

## 一、 專案目錄結構概觀

本專案採用前後端分離（Client-Server）架構設計：
- **前端 (Client)**: 建立於 `React.js` + `Vite` + `TailwindCSS`。
- **後端 (Server)**: 建立於 `Node.js` + `Express.js` + `better-sqlite3`。

```text
倉庫出入料系統/
├── client/                     # 前端 React 應用程式 (Vite)
│   ├── src/
│   │   ├── api.js              # 集中管理所有與後端溝通的 Axios API 請求
│   │   ├── components/         # 可共用的 UI 元件 (如: MapGrid.jsx, Layout.jsx, ProtectedRoute.jsx)
│   │   ├── pages/              # 各個獨立路由頁面 (如: 總覽看板, 庫存查詢, 資料匯入中心等)
│   │   ├── App.jsx             # React 路由 (React Router) 的根節點與權限管理入口
│   │   ├── index.css           # 全域樣式與 Tailwind 指令庫
│   │   └── main.jsx            # React 應用的進入點
│   ├── package.json            # 前端依賴配置
│   └── vite.config.js          # Vite 構建配置 (包含預設 Port: 5173 與 Proxy)
│
├── server/                     # 後端 Node.js 應用程式
│   ├── server.js               # Express 核心伺服器，包含所有 API 路由與資料庫連線/遷移邏輯
│   ├── warehouse.db            # SQLite 資料庫主檔 (better-sqlite3)
│   ├── package.json            # 後端依賴配置
│   └── init_db.js              # (可選) 獨立的資料庫初始化腳本
│
├── input/                      # 存放供系統匯入的 Excel 原始資料檔 (料件、盤點、儲位圖等)
├── run_locally.bat             # 一鍵啟動腳本 (包含 Node.js 路徑動態偵測機制與依賴安裝)
├── docker-compose.prod.yml     # 生產環境的 Docker 部署配置檔
└── 部署手冊_Server.md           # 系統部署說明文件
```

---

## 二、 資料庫架構 (SQLite)

後端採用 `better-sqlite3` 進行輕量且高效的本機資料庫操作，所有的資料表結構定義於 `server.js` (`initDb` 函數) 內，並備有自動遷移機制 (Migrations)。

### 核心資料表 (Tables)

1. **`users` (使用者表)**
   - 記錄 `employee_id`(工號/帳號), `password`(密碼), `permissions`(JSON 格式的權限陣列), `group_name`(群組：如管理者/一般使用者)。
   - 採用簡單驗證與 Token (Base64 JSON Payload) 機制，未引入複雜的 JWT 套件。

2. **`items` (料件主檔)**
   - 記錄 `barcode` (料號，唯一鍵), `name` (品名), `description` (規格), `category` (庫別), `unit` (單位)。
   - 當匯入新的料件主檔 Excel 時，若料號不在此檔案內，會觸發**完全覆蓋機制**，一併刪除舊料件、庫存與交易紀錄。

3. **`locations` (儲位主檔)**
   - 記錄 `code` (儲位代碼), `x`, `y` (二維平面圖的網格座標), `type` (一般貨架 'SHELF' 或其他)。
   - 特別標籤 `#V_#` 開頭的 code 用於渲染 UI 上的靜態障礙物與標籤 (如：柱子、大門、走道名稱)。
   - 匯入新地圖時，會清除不再使用的舊儲位座標 (前提是該儲位庫存為 0)。

4. **`inventory` (庫存表)**
   - 作為 `items` 和 `locations` 的關聯表，記錄 `(item_id, location_id, quantity)`。
   - 保證了同一儲位可以存放多種料件，同一料件也可分散在多個儲位。

5. **`transactions` (異動紀錄表)**
   - 記錄每次的 `IN` 或 `OUT` 操作 (`item_id`, `location_id`, `quantity`, `type`, `user_id`, `timestamp`)。
   - 支援**軟刪除 (Soft Delete)** 機制 (`is_deleted`, `deleted_by`)，允許管理員「作廢」錯誤的出入庫操作並自動還原庫存。

6. **`bom_items` (BOM 表/配方表)**
   - 定義產品結構 (`main_barcode` 主件 -> `component_barcode` 元件 -> `required_qty` 需求數量)。
   - 用於支援「按 BOM 表批量出庫」的進階功能。

---

## 三、 後端核心邏輯分析 (`server.js`)

`server.js` 是一個單體式 (Monolithic) 的 Express 伺服器，大約 1000 行，負責所有 API。

### 1. 資料匯入機制 (Import APIs)
* **API 路徑**: `/api/admin/import/items` 等。
* **技術特點**:
  * **交易 (Transaction) 包裝**: 使用 `db.transaction(() => {...})` 包裝迴圈中的多筆 `db.prepare().run()`，確保要麼全部成功，要麼全部回滾，大幅提升寫入效能與資料一致性。
  * **完全覆蓋邏輯 (Overwrite)**: 在最新版本中，料件和地圖匯入會先將 `NOT IN (上傳清單)` 的舊資料直接 `DELETE`（並級聯刪除庫存與交易紀錄），確保系統跟最新的 Excel 完全同步，不留疊加的孤兒資料。

### 2. 資料查詢與報表 (Reports)
* **API 路徑**: `/api/reports/inventory`, `/api/items` 等。
* **技術特點**: 
  * 運用 `LEFT JOIN` 同時串接 `items`, `inventory`, `locations` 三張表。
  * 使用 SQLite 特有的 `GROUP_CONCAT` 或嵌套 Select 將一個料件在「不同儲位的庫存狀態」彙整為單一字串或陣列，方便前端直接渲染。

### 3. 動態儲位圖資料整合
* **API 路徑**: `/api/locations` 
* **技術特點**: 先將所有 Location 基本資料抓取，再透過記憶體 Map 結構將 Inventory 中有庫存的料號與數量 Push 對應到每一個儲位中，最後吐給前端一個包含了 `items: []` 和 `total_quantity` 的結構，避免 JOIN 產生的資料冗餘。

### 4. 權限中介軟體 (Middleware)
* **`requireAdmin`**: 攔截受保護的 API (如使用者的增刪改、進階匯入)。透過解碼 Request Header 中的 Authentication Base64 JSON，檢查 `payload.group === '管理者'` 或持有 `ALL` 權限。

---

## 四、 前端核心邏輯分析 (React)

前端的重點在於提供快速響應的使用者體驗，特別是處理大量網格算繪的動態地圖。

### 1. 狀態與路由管理 (`App.jsx` & `ProtectedRoute.jsx`)
* **路由配置**: 使用 `React Router v6` 進行頁面導航 (`/`, `/inventory`, `/operations`, `/import` 等)。
* **權限攔截**: 透過封裝 `<ProtectedRoute>` 元件，讀取 `localStorage` 內的 token 或使用者權限，若無權限訪問特定頁面（如 `admin` 相關的 Import/User 管理層級）會直接將其 Redirect 回總覽頁面。

### 2. 動態地圖渲染核心 (`components/MapGrid.jsx`)
這是整個專案在 UI 上最具挑戰性與亮點的元件。
* **動態網格計算 (`useMemo`)**: 
  * 前端收到後端傳來的散落 `(x, y)` 座標後，透過 `Math.max` 找出邊界，動態建立一個二維陣列 (Grid Matrix)。
  * 利用 CSS Grid `grid-template-columns` 屬性動態產生版面，網格大小自適應。
* **特殊視覺標籤解析 (`#V_#`)**: 
  * Excel 中的合併儲存格 (如走道、大門) 在後端被編碼為 `#V_#[文字]_[X]_[Y]_[SpanX]_[SpanY]` 格式傳給前端。
  * `MapGrid.jsx` 會解析這些標籤，並使用 CSS 的 `grid-column: span N` 和 `grid-row: span M` 長出大塊的矩形區域。
  * 對於被 span 覆蓋到的底層網格，標記為 `COVERED` 直接 `return null` 不渲染，避免 DOM 結構重疊擠壓。
* **高亮與庫存互動 (`highlights` Prop & Render)**:
  * 支援傳入 `highlights` 陣列（如 BOM 表出庫時的目標儲位）。
  * 運用 `framer-motion` 加入動畫效果，並動態變化 Tailwind class (如 `bg-red-500`, `animate-ping`) 幫助庫房人員一眼找到該去哪裡撿料。
  * **Tooltip 設計**: 滑鼠懸浮 (Hover) 可看見儲位內的詳細料號庫存清單。

### 3. API 整合統一 (`api.js`)
* 利用 `axios` 創建統一個實例，設定 `baseURL: http://localhost:3000/api`。
* 所有前端與後端的 Request 行為皆被封裝成明確命名的非同步函數 (如 `importItems(data)`, `voidTransaction(id, pwd)` 等)，讓頁面組件內部的程式碼維持整潔。

---

## 五、 其他系統亮點與巧思

1. **一鍵啟動腳本 (`run_locally.bat`)**
   * 內建了**智慧型 Node.js 路徑偵測**機制。
   * 會自動尋找環境變數與常見安裝路徑 (例如 `C:\Users\...\node.exe`)，如果找不到會請求使用者輸入一次路徑並快取至本地的 `.node_path` 中。
   * 後續即可一鍵啟動後端的 Express 服務和前端的 Vite 服務，自動安裝 `node_modules` 依賴，大幅降低換機開發與部署的障礙。

2. **防呆與警告機制**
   * 在進行破壞性操作 (例如刪除庫存料件、完全覆蓋匯入資料) 時，前端皆有明確的 Warning `window.confirm()` 攔截。
   * 防治作廢 (Voiding) 的多次操作，一旦交易紀錄 is_deleted 為 true 就不允許再次觸發。
   * 如果強制作廢，會動態回補或扣除目前的 `inventory` 數量。

此專案展現了良好的「實用導向」架構，以輕量級的 SQLite 為核心，不依賴龐大的外掛或複雜的 ORM，透過手寫 SQL 極大化效能。前端利用 Tailwind + 自定義二維矩陣地圖組件，完美實現了傳統 WMS 系統少見的「真實視覺化」倉儲找料體驗。
