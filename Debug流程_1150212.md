# 平面圖顯示異常修正與優化流程紀錄 (Debug流程_1150212)

**日期:** 2026-02-12  
**目標:** 修正平面圖儲位代碼顯示異常，並優化視覺呈現。

## 1. 儲位代碼 (Header) 顯示異常

### 🔴 問題描述
- 用戶回報平面圖上方的儲位代碼僅顯示數字 "4"，而非預期的完整代碼（如 "4A11"）。
- 預期顯示：4A11
- 實際顯示：4

### 🔍 排查過程
1. **檢查前端邏輯 (`MapGrid.jsx`)**:
   - 原本邏輯為 `loc.code.split('-')[0]`。
   - 懷疑儲位代碼格式並非預期的 `Prefix-Suffix` 格式。
2. **檢查後端數據**:
   - 執行 `curl http://localhost:3000/api/locations` 獲取實際數據。
   - 發現數據被截斷，改用 Node.js 腳本直接讀取 Excel 來源。
   - 確認 Excel 內的實際代碼格式為 `4-A-1-1`。
3. **分析原因**:
   - `split('-')[0]` 只會抓到第一個部分 "4"，導致所有 Header 都顯示 "4"。

### ✅ 解決方案
- 修改前端代碼截取邏輯，將所有 `-` 去除，保留完整代碼。
- **原始代碼**: `const headerCode = firstLoc ? firstLoc.code.split('-')[0] : '';`
- **修正後代碼**: `const headerCode = firstLoc ? firstLoc.code.replace(/-/g, '') : '';`
- **結果**: 成功顯示 "4A11"。

---

## 2. 增加左側列編號 (Row Numbers)

### 🔴 需求描述
- 在平面圖左側增加 1-12 的列編號，以便識別。

### ✅ 實作方法
1. **調整 Grid 佈局**:
   - 修改 CSS Grid 設定，新增一欄固定寬度 (30px) 用於放標號。
   - `gridTemplateColumns: 30px repeat(${dims.maxX}, minmax(40px, 1fr))`
2. **渲染邏輯**:
   - 在每一列開始渲染 Grid Cells 之前，先插入一個 `div` 顯示 `y + 1`。
   - 左上角 (0,0 之前) 補一個空白 `div` 佔位。

---

## 3. 儲位內容顯示優化

### 🔴 需求描述
- 儲位格子內原本顯示的是位置後綴（如 1, 2, 3），使用者希望改為顯示「料件數量」。

### ✅ 實作方法
- 修改 `MapGrid.jsx` 的渲染內容。
- **原始**: `{loc.code.split('-').pop()}` (顯示代碼最後一碼)
- **修正**: `{loc.total_quantity > 0 ? loc.total_quantity : ''}`
- **邏輯**:
  - 如果 `total_quantity > 0`，顯示數量。
  - 如果無庫存，顯示空白。

---

## 總結
經過以上三個步驟的修正與優化，平面圖現在具備：
1. **上方**: 正確顯示儲位區域名稱 (如 4A11)。
2. **左側**: 清晰的列編號 (1~12)。
3. **格內**: 直觀的庫存數量顯示。

---

## 4. Docker 啟動失敗排除

### 🔴 問題描述
- 啟動 Docker 容器時發生錯誤，導致後端服務無法執行。
- 錯誤訊息通常與 `better-sqlite3` 或模組版本不兼容有關。

### ✅ 解決方案
- **原因**: `better-sqlite3` 屬於 Native Module，在不同作業系統或 Node.js 版本間無法直接共用編譯結果。Alpine Linux 環境下特別容易發生此問題。
- **修正**:
    1. 調整 `Dockerfile`，確保 Build Stage 與 Runtime Stage 環境一致。
    2. 在容器建置過程中重新編譯 `better-sqlite3`。
    3. 修正 Docker Volume 掛載路徑，確保 Excel 檔案能被容器讀取。

---

## 5. 前端畫面跑版 (復古風格/無樣式)

### 🔴 問題描述
- 專案啟動後，網頁呈現類似 90 年代的「復古」風格，所有現代化樣式 (Tailwind CSS) 均未生效。

### ✅ 解決方案
- **原因**: 專案中缺少 PostCSS 設定檔，導致 Vite 無法正確處理 Tailwind CSS。
- **修正**: 新增 `postcss.config.js` 檔案，並配置 `tailwindcss` 與 `autoprefixer`。

---

## 6. 地圖空白無內容

### 🔴 問題描述
- 進入 Dashboard 後，平面圖區域完全空白，未顯示任何儲位格子。

### ✅ 解決方案
- **原因**:
    1. 資料庫初始化時未正確讀取到 `20260210 料架QRcode.xlsx`，導致 `locations` 資料表為空。
    2. API `/api/locations` 回傳空陣列。
- **修正**:
    1. 修正後端 `server.js` 的檔案路徑判定邏輯，加入對應 Docker 環境的絕對路徑檢查。
    2. 確認 Excel 讀取成功並執行 `seedLocations()` 將資料寫入資料庫。
    3. 前端 `MapGrid.jsx` 加入資料載入檢查，確保有數據時才渲染網格。
